name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Exercises
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run validation tests
        run: bun test tests/exercises/validation.test.ts

      - name: Run JavaScript/TypeScript syntax tests
        run: bun test tests/exercises/syntax/javascript.test.ts

  python:
    name: Python Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: bun install

      - name: Run Python syntax tests
        run: bun test tests/exercises/syntax/python.test.ts

  rust:
    name: Rust Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: bun install

      - name: Run Rust syntax tests
        run: bun test tests/exercises/syntax/rust.test.ts

  swift:
    name: Swift Syntax
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Verify Swift
        run: swiftc --version

      - name: Install dependencies
        run: bun install

      - name: Run Swift syntax tests
        run: bun test tests/exercises/syntax/swift.test.ts

  kotlin:
    name: Kotlin Syntax
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Kotlin
        run: |
          curl -L https://github.com/JetBrains/kotlin/releases/download/v2.0.0/kotlin-compiler-2.0.0.zip -o kotlin.zip
          unzip kotlin.zip
          echo "$PWD/kotlinc/bin" >> $GITHUB_PATH

      - name: Verify Kotlin
        run: kotlinc -version

      - name: Install dependencies
        run: bun install

      - name: Run Kotlin syntax tests
        run: bun test tests/exercises/syntax/kotlin.test.ts --timeout 300000

  web:
    name: HTML/CSS Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run HTML/CSS tests
        run: bun test tests/exercises/syntax/html-css.test.ts

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: bun install

      - name: Type check server
        run: bun x tsc --noEmit -p tsconfig.json

      - name: Build Angular app
        run: bun run build:prod

  all-tests:
    name: All Tests Pass
    needs: [validate, python, rust, swift, kotlin, web, build]
    runs-on: ubuntu-latest
    steps:
      - name: All tests passed
        run: echo "All CI checks passed successfully!"
